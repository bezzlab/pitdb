{% extends "layoutTables.html" %}
{% block content %}
  
<div class="navbar-default sidebar" role="navigation">
  <div class="sidebar-nav navbar-collapse">
    <ul class="nav" id="side-menu">
      <li class="sidebar-search">
        <div class="input-group custom-search-form">
          <input type="text" class="form-control" placeholder="Search...">
          <span class="input-group-btn">
            <button class="btn btn-default" type="button">
              <i class="fa fa-search"></i>
            </button>
          </span>
        </div>

      </li>
      <li><a href="#summary"><i class="fa fa-dashboard fa-fw"></i> TGEs</a></li>
    </ul>
    </div>
  </div>

  <div id="page-wrapper">
    <div class="row">
      <div class="col-lg-12">
        <h1 class="page-header">Uniprot ID: {{ uniprot }}</h1>
      </div>
    </div>

    <div class="row">
      <div>
      	<div class="panel panel-default" id="summary">
          <div class="panel-heading">
            <i class="fa fa-bar-chart-o fa-fw"></i> TGEs
          </div>
          
          <div class="panel-body">
            <div class="row" style="margin-left:5px">
            <table id="proteinRes" class="table table-striped table-bordered dataTable no-footer" class="searchRes">
            <thead>
              <tr>
                <th>TGE Accession</th>
                <th>TGE Type</th>
              </tr>
            </thead>
            <tbody>
              {% for tge in tges %}
                <tr>
                  <td>{{ tge.accession }}</td>
                  <td>{{ tge.tge_class }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          	</div>
          </div>
      </div>

      <div>
        <div class="panel panel-default" id="summary">
          <div class="panel-heading">
            <i class="fa fa-bar-chart-o fa-fw"></i> Genoverse
          </div>
          
          <div class="panel-body">
            <div id="genoverse"></div>
          </div>
      </div>
    </div>
  </div>
</div>

<script src="/static/js/ext/jquery-2.1.4.min.js"></script>

<script type="text/javascript" src="/static/js/genoverse.combined.js"></script>
<script type="text/javascript" src="/static/js/genomes/grch38.js"></script><!-- 
<script type="text/javascript" src="/static/js/Track/Model/Transcript/GFF3.js"></script>
<script type="text/javascript" src="/static/js/plugins/fileDrop.js"></script>
<script type="text/javascript" src="/static/js/Track/View/Transcript.js"></script>
<script type="text/javascript" src="/static/js/Track/View/Gene/Ensembl.js"></script>
<script type="text/javascript" src="/static/js/Track/View/Transcript/Ensembl.js"></script>
<script type="text/javascript" src="/static/js/Track/View.js"></script> -->

<script>
  var chrParam = getParam("seqid");
  
  if (chrParam == null || chrParam == '') {
    chrParam = 2;
  }

  var genoverseConfig = {
    container : '#genoverse',
    width     : 900,
    genome    : 'grch38',
    chr       : chrParam,
    start     : 215350030,
    end       : 215436000,
    plugins   : [ 'controlPanel', 'karyotype', 'trackControls', 'resizer', 'fileDrop' ],
    tracks    : [
      Genoverse.Track.Scalebar,
      Genoverse.Track.extend({
        name      : 'Sequence',
        model     : Genoverse.Track.Model.Sequence.Ensembl,
        view      : Genoverse.Track.View.Sequence,
        resizable : 'auto',
        100000    : false
      }),
      Genoverse.Track.extend({
        name   : 'Genes',
        height : 200,
        info   : 'Ensembl API genes & transcripts, see <a href="http://beta.rest.ensembl.org/" target="_blank">beta.rest.ensembl.org</a> for more details',
        
        // Different settings for different zoom level
        2000000: { // This one applies when > 2M base-pairs per screen
          labels : false
        },
        100000: { // more than 100K but less then 2M
          labels : true,
          model  : Genoverse.Track.Model.Gene.Ensembl,
          view   : Genoverse.Track.View.Gene.Ensembl
        },
        1: { // > 1 base-pair, but less then 100K
          labels : true,
          model  : Genoverse.Track.Model.Transcript.Ensembl,
          view   : Genoverse.Track.View.Transcript.Ensembl
        }
      }),
      // Genoverse.Track.extend({
      //   name   : 'Transcript',
      //   height : 300,
      //   url    : '/data/test',
      //   model  : Genoverse.Track.Model.extend({
      //     dataType : 'text',
      //     typeMap : {
      //       exon  : 'exon',
      //       cds   : 'cds'
      //     },
      //     parseData: function (text) {

      //       var lines = text.split('\n');

      //       for (var i = 0; i < lines.length; i++) {
      //         if (!lines[i].length || lines[i].indexOf('#') === 0) {
      //           continue;
      //         }

      //         var fields = lines[i].replace(/\s{2,}/g, '\t').split('\t');
              
      //         if (fields[0] === this.browser.chr || fields[0].toLowerCase() === 'chr' + this.browser.chr || fields[0].match('[^1-9]' + this.browser.chr + '$')) {
                
      //           var feature = {};

      //           feature.id     = fields.slice(0, 5).join('|');
      //           feature.start  = parseInt(fields[3], 10);
      //           feature.end    = parseInt(fields[4], 10);
      //           feature.source = fields[1];
      //           feature.type   = fields[2];
      //           feature.score  = fields[5];
      //           feature.strand = fields[6] + '1';

      //           if (fields[8]) {
      //             var frame = fields[8].split(';');

      //             for (var j = 0; j < frame.length; j++) {
      //               var keyValue = frame[j].split('=');

      //               if (keyValue.length === 2) {
      //                 feature[keyValue[0].toLowerCase()] = keyValue[1];
      //               }
      //             }
      //           }

      //           // sub-feature came earlier than parent feature
      //           if (feature.parent && feature.type == "mRNA") {
      //             this.insertFeature(feature);

      //             this.featuresById[feature.id] = {
      //               exons : [],
      //               cds   : []
      //             };
      //           }


      //           // If happiness
      //           if (feature.parent && feature.type.toLowerCase() === this.typeMap.exon.toLowerCase()) {
      //             if (!$.grep(this.featuresById[feature.parent].exons, function (exon) { return exon.id === feature.id; }).length) {
      //               this.featuresById[feature.parent].exons.push(feature);
      //             }
      //             //this.insertFeature(feature);
      //           } else if (feature.parent && feature.type.toLowerCase() === this.typeMap.cds.toLowerCase()) {
      //             if (!$.grep(this.featuresById[feature.parent].cds, function (exon) { return exon.id === feature.id; }).length) {
      //               this.featuresById[feature.parent].cds.push(feature);
      //             }
      //             //this.insertFeature(feature);
      //           } else if (!feature.parent) {
      //             feature.label = feature.name || feature.id || '';
      //             $.extend(feature, { label: feature.name || feature.id || '', exons: [], cds: [] }, this.featuresById[feature.id] || {});

      //             delete this.featuresById[feature.id];

      //             this.insertFeature(feature);
      //           } // end of if
      //         }
      //       }
      //       // alert(feature.parent);
      //       // alert(this.featuresById[feature.parent].exons.length);
      //       // alert(this.featuresById[feature.parent].cds.length);
      //       // return;
      //     }
      //   }),
      //   view   : Genoverse.Track.View.Transcript,
      // }), 
      // Genoverse.Track.extend({
      //   name      : 'GFF3',
      //   height    : 200,
      //   model     : Genoverse.Track.Model.Transcript.GFF3,
      //   view      : Genoverse.Track.View.Transcript,
      //   resizable : 'false',
      //   url       : '/data/test',
      //   // 2000000: { // This one applies when > 2M base-pairs per screen
      //   //   labels : false
      //   // },
      //   // 100000: { // more than 100K but less then 2M
      //   //   labels : true,
      //   //   view   : Genoverse.Track.View.Transcript
      //   // },
      //   // 1: { // > 1 base-pair, but less then 100K
      //   //   labels : true,
      //   //   view   : Genoverse.Track.View.Transcript.Ensembl
      //   // }
      // }),
      // Genoverse.Track.extend({
      //   name   : 'Shyama',
      //   view   : Genoverse.Track.View.Transcript.extend({
      //     setFeatureColor : function () {}
      //   }),
      //   height : 100,
      //   url    : '/data/test',
      //   model  : Genoverse.Track.Model.extend({
      //     dataType : 'text',
      //     parseData: function (text) {
      //       var lines = text.split('\n');
      //       for (var i = 0; i < lines.length; i++) {

      //         if (!lines[i].length || lines[i].indexOf('#') === 0) {
      //           continue;
      //         }
              
      //         var fields = lines[i].split('\t');

      //         if (fields[0] === this.browser.chr || fields[0].toLowerCase() === 'chr' + this.browser.chr || fields[0].match('[^1-9]' + this.browser.chr + '$')) {

      //           var feature = {
      //             id     : fields.slice(0, 5).join('|'),
      //             start  : parseInt(fields[3], 10),
      //             end    : parseInt(fields[4], 10),
      //             exons  : [],
      //             cds    : []
      //           };

      //           if (fields[8]) {
      //             var extraFields = fields[8].split(';');
                  
      //             for (var j = 0; j < extraFields.length; j++) {
      //               var keyValue = extraFields[j].split('=');
                    
      //               if (keyValue.length === 2 && !feature[keyValue[0]]) {
      //                 feature[keyValue[0].toLowerCase()] = keyValue[1];
      //               }
      //             }
      //           }

      //           feature.color = 'rgb(' + feature.color + ')';

      //           // CIGAR Gap, here we assume it's always M or D, with D only being surrounded with Ms
      //           if (feature.gap) {
      //             var cursor = feature.start;
      //             var chunks = feature.gap.split(' ');
      //             for (var j=0; j<chunks.length; j++) {
      //               if (chunks[j].charAt(0) === 'M') {
      //                 var length = parseInt( chunks[j].substr(1), 10 );
      //                 feature.exons.push({
      //                   start : cursor,
      //                   end   : cursor + length,
      //                 });
      //                 feature.cds.push({
      //                   start : cursor,
      //                   end   : cursor + length,
      //                   color : feature.color,
      //                 });
      //                 cursor = cursor + length;
      //               }
      //               else {
      //                 var length = parseInt(chunks[j].substr(1), 10);
      //                 cursor += length;
      //               }
      //             }
      //           }

      //           feature.labelColor = 'black';
      //           feature.label = feature.name;

      //           this.insertFeature(feature);
      //         }

      //       }
      //     }
      //   }),
      // })
      Genoverse.Track.extend({
        name   : 'GFF3',
        height : 200,
        //info   : 'Ensembl API genes & transcripts, see <a href="http://beta.rest.ensembl.org/" target="_blank">beta.rest.ensembl.org</a> for more details',
        url : '/data/test',
        //info   : 'Ensembl API genes & transcripts, see <a href="http://beta.rest.ensembl.org/" target="_blank">beta.rest.ensembl.org</a> for more details',
        view   : Genoverse.Track.View.Transcript.extend({
                setFeatureColor : function () {}
        }),    
        model : Genoverse.Track.Model.Transcript.extend(
        {
        dataType : 'text',
            typeMap : {
                exon  : 'exon',
                cds   : 'cds',
                mrna  : 'mrna',
                gene  : 'gene'
            },
        parseData: function (text) {
      //alert(text)
      //alert("1. parent:"+feature.parent)
      //alert("1. type:"+feature.type)
      var lines = text.split('\n');
                var gene;
          for (var i = 0; i < lines.length; i++) {
                    if (!lines[i].length || lines[i].indexOf('#') === 0) {
                        continue;
                    }
                    //alert(lines[i])
                    var fields = lines[i].split('\t');
            
                    if (fields.length < 5) {
                        continue;
                    }
            
                    if (fields[0] === this.browser.chr || fields[0].toLowerCase() === 'chr' + this.browser.chr || fields[0].match('[^1-9]' + this.browser.chr + '$'))
                    {
                        var feature = {};
    
                        feature.id     = fields.slice(0, 5).join('|');
                        feature.start  = parseInt(fields[3], 10);
                        feature.end    = parseInt(fields[4], 10);
                        feature.source = fields[1];
                        feature.type   = fields[2];
                        feature.score  = fields[5];
                        feature.strand = fields[6] + '1';
    
                        if (fields[8]) {
                            var frame = fields[8].split(';');
                            
                            for (var j = 0; j < frame.length; j++) {
                                var keyValue = frame[j].split('=');
                                
                                if (keyValue.length === 2) {
                                    feature[keyValue[0].toLowerCase()] = keyValue[1];
                                }
                            }
                        }
                        //alert("0. parent:"+feature.parent)
                        //alert("0. type:"+feature.type)
                        //alert(gene)
                        //alert("type:"+feature.type.toLowerCase())
                        //alert("type:"+this.typeMap.mrna.toLowerCase())
                        // sub-feature came earlier than parent feature
                        //if (feature.parent && feature.type.toLowerCase() === this.typeMap.mrna.toLowerCase() && !this.featuresById[feature.id]) {
                        if(feature.type.toLowerCase() === this.typeMap.gene.toLowerCase())
                        {
                            //alert("gene");
                            if(typeof gene !== "undefined" && gene)
                            {
                                //alert("gene features entering");
                                for(var g=0; g<gene.mrna.length; g++)
                                {
                                    this.insertFeature(gene.mrna[g]);
                                }
                            }
                            feature.mrna=[];
                            gene=feature;
                            //alert("gene id:"+gene.id);
                            //alert("gene mRNA:"+gene.mrna.length);
                        }
                        else if(feature.type.toLowerCase() === this.typeMap.mrna.toLowerCase())
                        {
                            //alert('mRNA');
                            feature.exons=[];
                            feature.cds=[];
                            if(gene!==undefined)
                            {
                                gene.mrna.push(feature);
                                //alert("gene not undefined:"+gene.mrna.length);
                            }
                            //alert('mRNA2');
                        }
                        else if (feature.parent && feature.type.toLowerCase() === this.typeMap.exon.toLowerCase()) {
                            //alert("exon");
                            var idx = gene.mrna.length - 1;
                            
                            //alert("idx="+idx)
                            gene.mrna[idx].exons.push(feature); //assuming last mRNA is the parent of this exon
                            //alert("exon pushed");
                        }
                        else if (feature.parent && feature.type.toLowerCase() === this.typeMap.cds.toLowerCase()) {
                            //alert("cds");
                            var idx=gene.mrna.length-1;
                            feature.color = '#B0171F';
                            gene.mrna[idx].cds.push(feature); //assuming last mRNA is the parent of this cds
                            //alert("cds pushed");
                        }
                        
                    } //end of if
          }//end of forloop
                if(typeof gene !== "undefined" && gene)
                {
                    //alert("gene features entering");
                    for(var g=0; g<gene.mrna.length; g++)
                    {
                        this.insertFeature(gene.mrna[g]);
                    }
                }
                //alert()
            } //end of function
      })
        })//,
    ]
  };
  
  document.addEventListener('DOMContentLoaded', function () { 
    window.genoverse = new Genoverse(genoverseConfig); 
  });

  function getParam(name){
    if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
      return decodeURIComponent(name[1]);
  }
</script>

{% endblock %}
